## 三次握手
- 过程
  - client发送SYN=j，并进入**SYN_SENT**状态
  - server发送SYN=(j\+1)\+ACK=k包，确认SYN，进入**SYN_RECV**状态
  - client检查ACK，发送ACK=(k\+1)，A B进入**ESTABLISHED**状态
- 为什么是3次？
  - TCP要在不可靠的信道上进行可靠的传输；3次是理论上确认数据传输可靠的最小值
  - 第2次握手A知道B能收到A的消息
  - 第3次握手B知道了A知道B能收到A的消息，如果没有收到，则B不用无谓等待
- SYN攻击
  - 一种典型的DDOS攻击
  - Client在**短时间内伪造大量不存在的IP地址**，并向Server不断地发送SYN包，Server回复确认包，并等待Client的确认，由于源地址是不存在的，因此，**Server需要不断重发直至超时**，这些伪造的SYN包将**长时间占用未连接队列**，导致正常的SYN请求因为队列满而被丢弃，从而引起网络堵塞甚至系统瘫痪。
  - 检测：当Server上有大量半连接状态且源IP地址是随机的，则可以断定遭到SYN攻击了
  
## 四次挥手
- 由于TCP连接时全双工的，因此，每个方向都必须要单独进行关闭
- 过程
  - client向B发送FIN(状态位FIN=1,发送seq=J)，client进入**FIN_WAIT_1**
  - Server向client发送ACK(状态位ACK=1，发送ack=J+1)，Server进入**CLOSE_WAIT**状态
  - Server向client发送FIN(状态位FIN=1,发送seq=K)，Server进入**LAST_ACK**状态
  - client向Server发送ACK，进入**TIME_WAIT**状态
  - Server收到ACK就关闭连接，client等待2MSL后仍然没有收到回复，也关闭连接(等待2MSL是为了防止server没有收到消息重发FIN)
- 为什么是四次挥手？
  - TCP是双向传输，一边发送完毕不代表对方也发送完毕。
- 为什么TIME_WAIT状态需要经过2MSL(最大报文段生存时间)才能返回到CLOSE状态?
  - 保证TCP协议的全双工连接能够可靠关闭
    - 如果Client直接关闭，Server有可能没有收到Client最后回复的ACK而在超时后继续发送FIN，此时会收到RST而不是ACK，Server会认为是错误而向高层汇报
  - 保证这次连接的重复数据段从网络中消失
    - 如果Client直接关闭后又向Server发起新连接，如果前后两次端口相同，之前发送延迟的(还没到Server的)数据包会被当做新连接的数据，导致混淆。
  
## TCP拥塞控制
### 发送窗口
- TCP传输数据包之后，**需要等待确认包是否到达**，这样就花费了一个往返时间
- 发送方要知道接收方的接收窗口和网络这两个限制因素哪一个更加严格然后在其限制范围内尽可能的多发包
- 每个包的TCP层都含有**Window size value**，这个值并不是指发送窗口的大小，而是在**向对方声明自己的接收窗口**。
- 发送窗口决定一次能够发送的字节数，而MSS决定了这些字节需要分多少个包才能发完。举例：在发送窗口为16000字节的情况下，如果MSS是1000字节，那么需要发送16个包；如果MSS为8000字节，那么发送的包数即为2。
### 慢启动过程
- 连接刚刚建立，发送方对网络状况一无所知。如果一次发送太多的数据就可能遭遇拥塞，所以把发送方的拥塞窗口初始值定的很小，RFC的建议是2个、3个或者4个MSS(最大报文长度)
- 发出去的包都得到确认，表明还没有到达拥塞点，可以增大拥塞窗口。由于这个阶段发送拥塞的概率很低，所以增速可以快一些。RFC建议的算法是每收到n个确认，可以把拥塞窗口增加n个MSS。这个过程的增速很快，但是由于基数低，传输速度还是比较慢的，所以被称为慢启动过程
### 拥塞避免
- 慢启动过程持续一段时间后，拥塞窗口达到一个较大的值。这时候传输速度比较快，触碰拥塞点的概率也大了，所以不能再采用翻倍的慢启动算法了，而是要更加缓慢一些。RFC建议是每个往返时间增加一个MSS。这个过程被称为拥塞避免
- 如果之前发生过拥塞，那么就把该拥塞点作为参考依据，如果从来没有发生过拥塞就可以取相对较大的值，比如和最大接收窗口相等
### 超时重传
- 拥塞之后，对于发送方来说就是发出去的包得不到确认了，不过收不到确认也可能是网络延迟导致，所以发送方会等待一会儿再判断，如果迟迟收不到，那么就认定包已经丢失，只能重传了。这个过程被称为超时重传
- 从发出原始包到重传该包的时间被称为RTO
- 重传之后的拥塞窗口非常有必要调整，RFC建议把拥塞窗口下降到1个MSS，然后再次进入慢启动过程。这一次从慢启动过程过渡到拥塞避免的临界窗口值就有参考依据了。RFC建议临界窗口值为发生拥塞时没被确认的数据量的1/2，但是不能小于2个MSS。
### 快速重传
- 当发送方收到3个或者以上的重复确认（Dup Ack）时，就意识到相应的包已经丢失了，因此立即重传它
  
## Socket
  - 实际上socket是对TCP/IP协议的封装，Socket本身并不是协议，而是一个调用接口（API）
  - 创建Socket连接时，可以指定使用的传输层协议，Socket可以支持不同的传输层协议（TCP或UDP）

## UDP
- TCP面向连接，UPD无连接
- TCP为可靠传输
- TCP有流量控制和拥塞控制
- TCP连接为一对一，UDP可一对一、一对多、多对多
