### 事务
- 数据库管理系统执行过程中的一个逻辑单元，它能够保证一个事务中的所有操作要么全部执行，要么全不执行
- ACID

### 2PC
- **准备阶段**
  - 协调者(Coordinator)向事务的参与者（Cohort）询问是否可以执行操作的请求，并等待其他参与者的响应
  - 参与者会执行相对应的事务操作并记录**重做和回滚日志**
  - 所有执行成功的参与者会向协调者发送**AGREEMENT**或者**ABORT**表示执行操作的结果
- **提交阶段**
  - 当所有的参与者都返回了**确定的结果**（同意或者终止）时，两阶段提交就进入了提交阶段，协调者会根据投票阶段的返回情况向所有的参与者发送**提交**或者**回滚**的指令
  - 当有参与者决定 ABORT 当前事务时，协调者会向事务的参与者发送回滚请求，参与者会根据之前执行操作时的回滚日志对操作进行回滚并向协调者发送完成的消息
  - 无论如何，都会释放资源
- 问题
  - 同步阻塞：所有参与事务的逻辑均处于阻塞状态
  - 单点：协调者存在单点问题，如果协调者出现故障，参与者将一直处于锁定状态
  - 脑裂：在阶段2中，如果只有部分参与者接收并执行了Commit请求，会导致节点数据不一致

### 3PC
- **CanCommit**
  - 协调者向所有参与者发出包含事务内容的CanCommit请求，询问是否可以提交事务，并等待所有参与者答复。
  - 参与者收到CanCommit请求后，如果认为可以执行事务操作，则反馈YES并进入预备状态，否则反馈NO。
  - 任何一个参与者反馈NO，或者等待超时后协调者尚无法收到所有参与者的反馈，即中断事务
- **PreCommit**
  - 同2PC的准备阶段，但是增加了超时
- **do Commit**
  - 同2PC的提交阶段，但是增加了超时
- 问题：
  - 挠裂仍然存在，解决一致性问题，只有Paxos


### JTA
- 两阶段型事务
- 提供了分布式事务的解决方案，严格的ACID
- 事务补偿机制: 在事务链中的任何一个正向事务操作, 都必须存在一个完全符合回滚规则的可逆事务

### 柔性事务
- 定义
  - 满足ACID的事务成为刚性事务
  - 满足BASE理论的为柔性事务
- 分类
  - 两阶段型
  - 补偿型
  - 异步确保型
  - 最大努力通知型

### TCC
- 补偿型事务，本质也是两阶段型事务
- JTA为资源层事务，TCC为服务层事务
- Try：尝试执行业务
  - 完成所有业务检查(一致性)
  - 预留必须业务资源(准隔离性)
